<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="statisticalAnalysis">
<!-- 资源统计 资源量-->
    <select id="queryResourceTypeNum" resultType="com.jsrm.web.vo.statisticalAnalysis.StatisticalVo" parameterType="java.util.HashMap" >
		select
		MAX(case when c.resourceTypeOneLevelId = 'courseware' then c.num else 0 end) courseware,
		MAX(case when c.resourceTypeOneLevelId = 'microClass' then c.num else 0 end) smallclass,
		MAX(case when c.resourceTypeOneLevelId = 'instructionalDesign' then c.num else 0 end) design,
		MAX(case when c.resourceTypeOneLevelId = 'practice' then c.num else 0 end) practice,
		MAX(case when c.resourceTypeOneLevelId = 'sourceMaterial' then c.num else 0 end) material,
		MAX(case when c.resourceTypeOneLevelId = 'workRecord' then c.num else 0 end) learinng,
		MAX(case when c.resourceTypeOneLevelId = 'teachingResearch' then c.num else 0 end) research,
		MAX(case when c.resourceTypeOneLevelId = 'expandingResource' then c.num else 0 end) expand,
		MAX(case when c.resourceTypeOneLevelId = 'eTextbook' then c.num else 0 end) Etextbook,
		MAX(case when c.resourceTypeOneLevelId = 'teacherBook' then c.num else 0 end) teacherbook,
		MAX(case when c.resourceTypeOneLevelId = 'scheduleAndInterpretation' then c.num else 0 end) CurriculumAndInterpretation,
		MAX(case when c.resourceTypeOneLevelId = 'teachingVideo' then c.num else 0 end) teachingvideo,
		MAX(case when c.resourceTypeOneLevelId = 'experiment' then c.num else 0 end) experiment,
		MAX(case when c.resourceTypeOneLevelId = 'middleExam' then c.num else 0 end) mediumtest,
		MAX(case when c.resourceTypeOneLevelId = 'highExam' then c.num else 0 end) nationaltest,
		MAX(case when c.resourceTypeOneLevelId = 'primaryCompetition' then c.num else 0 end) primarytest,
		MAX(case when c.resourceTypeOneLevelId = 'middleCompetition' then c.num else 0 end) middletest,
		MAX(case when c.resourceTypeOneLevelId = 'highCompetition' then c.num else 0 end) hightest,
		MAX(case when c.resourceTypeOneLevelId = 'knowledgeExplanation' then c.num else 0 end) knowledgedetail,
		MAX(case when c.resourceTypeOneLevelId = 'learningVideo' then c.num else 0 end) studyvideo,
		MAX(case when c.resourceTypeOneLevelId = 'fullTextSolution' then c.num else 0 end) textexplain,
		MAX(case when c.resourceTypeOneLevelId = 'politicalPoints' then c.num else 0 end) currentpoint,
		MAX(case when c.resourceTypeOneLevelId = 'practiceEducation' then c.num else 0 end) practicaleducation,
		MAX(case when c.resourceTypeOneLevelId = 'terminology' then c.num else 0 end) nounsexplanation
		from(
		SELECT
		x.id,
		count(*) num,
		resourceTypeOneLevelId,
		createUserName,
		subjectId,
		phaseId
		FROM
		t_resouce_mid_categories trmc1
		inner JOIN t_resouce_mid_categories trmc2 ON trmc2.busiId = trmc1.busiId
		inner JOIN t_resouce_mid_categories trmc3 ON trmc3.busiId = trmc1.busiId
		inner JOIN t_resouce_mid_categories trmc4 ON trmc4.busiId = trmc1.busiId
		inner JOIN t_resource_info x ON trmc1.busiId = x.id
		WHERE
		1 = 1
		<if test=" userId != null and userId != ''">
			AND x.createUserId = #{userId}
		</if>
			AND trmc1.categDeep=1
			AND trmc2.categDeep=2
			AND trmc3.categDeep=3
			AND trmc4.categDeep=4
			AND x.resourceType = 'END'
			AND x.subjectId IS NOT NULL
			AND x.phaseId IS NOT NULL
			AND x.state = 3
		<if test="startTime != null and startTime != ''">
			and x.createDateTime &gt;= #{startTime}
		</if>
		<if test="endTime != null and endTime != ''">
			and x.createDateTime &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d 23:59:59.999')
		</if>
		<if test="phaseId != null and phaseId != ''">
			AND trmc1.tCategoriesId = #{phaseId}
		</if>
		<if test="subjectId != null and subjectId != ''">
			AND trmc2.tCategoriesId = #{subjectId}
		</if>
		<if test="version != null and version != ''">
			AND trmc3.tCategoriesId = #{version}
		</if>
		<if test="sakuji != null and sakuji != ''">
			AND trmc4.tCategoriesId = #{sakuji}
		</if>
		GROUP BY
		x.resourceTypeOneLevelId
		ORDER BY
		x.subjectId DESC
		) c
    </select>

	<select id="queryUploadNumber" resultType="com.jsrm.web.vo.statisticalAnalysis.UploadNumber" parameterType="java.util.HashMap" >
		select
		COUNT(*) uploadNumber
		from(
		SELECT
		x.id,
-- 		count(*) num,
		resourceTypeOneLevelId,
		createUserName,
		subjectId,
		phaseId
		FROM
		t_resouce_mid_categories trmc1
		inner JOIN t_resouce_mid_categories trmc2 ON trmc2.busiId = trmc1.busiId
		inner JOIN t_resouce_mid_categories trmc3 ON trmc3.busiId = trmc1.busiId
		inner JOIN t_resouce_mid_categories trmc4 ON trmc4.busiId = trmc1.busiId
		inner JOIN t_resource_info x ON trmc1.busiId = x.id
		WHERE
		1 = 1
		<if test=" userId != null and userId != ''">
			AND x.createUserId = #{userId}
		</if>
		AND trmc1.categDeep=1
		AND trmc2.categDeep=2
		AND trmc3.categDeep=3
		AND trmc4.categDeep=4
		AND x.resourceType = 'END'
		AND x.subjectId IS NOT NULL
		AND x.phaseId IS NOT NULL
		AND x.state = 3
		<if test="startTime != null and startTime != ''">
			and x.createDateTime &gt;= #{startTime}
		</if>
		<if test="endTime != null and endTime != ''">
			and x.createDateTime &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d 23:59:59.999')
		</if>
		<if test="phaseId != null and phaseId != ''">
			AND trmc1.tCategoriesId = #{phaseId}
		</if>
		<if test="subjectId != null and subjectId != ''">
			AND trmc2.tCategoriesId = #{subjectId}
		</if>
		<if test="version != null and version != ''">
			AND trmc3.tCategoriesId = #{version}
		</if>
		<if test="sakuji != null and sakuji != ''">
			AND trmc4.tCategoriesId = #{sakuji}
		</if>
-- 		GROUP BY
-- 		x.resourceTypeOneLevelId
		ORDER BY
		x.subjectId DESC
		) c
	</select>

	<select id="queryResourceTypeNumTotal" resultType="com.jsrm.web.vo.statisticalAnalysis.StatisticalVo" parameterType="java.util.HashMap" >
		select
			MAX(case when c.resourceTypeOneLevelId = 'courseware' then c.num else 0 end) courseware,
			MAX(case when c.resourceTypeOneLevelId = 'microClass' then c.num else 0 end) smallclass,
			MAX(case when c.resourceTypeOneLevelId = 'instructionalDesign' then c.num else 0 end) design,
			MAX(case when c.resourceTypeOneLevelId = 'practice' then c.num else 0 end) practice,
			MAX(case when c.resourceTypeOneLevelId = 'sourceMaterial' then c.num else 0 end) material,
			MAX(case when c.resourceTypeOneLevelId = 'workRecord' then c.num else 0 end) learinng,
			MAX(case when c.resourceTypeOneLevelId = 'teachingResearch' then c.num else 0 end) research,
			MAX(case when c.resourceTypeOneLevelId = 'expandingResource' then c.num else 0 end) expand,
			MAX(case when c.resourceTypeOneLevelId = 'eTextbook' then c.num else 0 end) Etextbook,
			MAX(case when c.resourceTypeOneLevelId = 'teacherBook' then c.num else 0 end) teacherbook,
			MAX(case when c.resourceTypeOneLevelId = 'scheduleAndInterpretation' then c.num else 0 end) CurriculumAndInterpretation,
			MAX(case when c.resourceTypeOneLevelId = 'teachingVideo' then c.num else 0 end) teachingvideo,
			MAX(case when c.resourceTypeOneLevelId = 'experiment' then c.num else 0 end) experiment,
			MAX(case when c.resourceTypeOneLevelId = 'middleExam' then c.num else 0 end) mediumtest,
			MAX(case when c.resourceTypeOneLevelId = 'highExam' then c.num else 0 end) nationaltest,
			MAX(case when c.resourceTypeOneLevelId = 'primaryCompetition' then c.num else 0 end) primarytest,
			MAX(case when c.resourceTypeOneLevelId = 'middleCompetition' then c.num else 0 end) middletest,
			MAX(case when c.resourceTypeOneLevelId = 'highCompetition' then c.num else 0 end) hightest,
			MAX(case when c.resourceTypeOneLevelId = 'knowledgeExplanation' then c.num else 0 end) knowledgedetail,
			MAX(case when c.resourceTypeOneLevelId = 'learningVideo' then c.num else 0 end) studyvideo,
			MAX(case when c.resourceTypeOneLevelId = 'fullTextSolution' then c.num else 0 end) textexplain,
			MAX(case when c.resourceTypeOneLevelId = 'politicalPoints' then c.num else 0 end) currentpoint,
			MAX(case when c.resourceTypeOneLevelId = 'practiceEducation' then c.num else 0 end) practicaleducation,
			MAX(case when c.resourceTypeOneLevelId = 'terminology' then c.num else 0 end) nounsexplanation
		from(
		SELECT
		x.id,
		count(*) num,
		resourceTypeOneLevelId,
		createUserName,
		subjectId,
		phaseId
		FROM
		t_resouce_mid_categories trmc1
		inner JOIN t_resouce_mid_categories trmc2 ON trmc2.busiId = trmc1.busiId
		inner JOIN t_resouce_mid_categories trmc3 ON trmc3.busiId = trmc1.busiId
		inner JOIN t_resouce_mid_categories trmc4 ON trmc4.busiId = trmc1.busiId
		inner JOIN t_resource_info x ON trmc1.busiId = x.id
		WHERE
		1 = 1
		<if test=" userId != null and userId != ''">
			AND x.createUserId = #{userId}
		</if>
		AND trmc1.categDeep=1
		AND trmc2.categDeep=2
		AND trmc3.categDeep=3
		AND trmc4.categDeep=4
		AND x.resourceType = 'END'
		AND x.subjectId IS NOT NULL
		AND x.phaseId IS NOT NULL
		AND x.state = 3
		<if test="startTime != null and startTime != ''">
			and x.createDateTime &gt;= #{startTime}
		</if>
		<if test="endTime != null and endTime != ''">
			and x.createDateTime &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d 23:59:59.999')
		</if>
		<if test="phaseId != null and phaseId != ''">
			AND trmc1.tCategoriesId = #{phaseId}
		</if>
		<if test="subjectId != null and subjectId != ''">
			AND trmc2.tCategoriesId = #{subjectId}
		</if>
		<if test="version != null and version != ''">
			AND trmc3.tCategoriesId = #{version}
		</if>
		<if test="sakuji != null and sakuji != ''">
			AND trmc4.tCategoriesId = #{sakuji}
		</if>
		GROUP BY
		x.resourceTypeOneLevelId
		ORDER BY
		x.subjectId DESC
		) c
	</select>

	<select id="queryKnowledgeNum" resultType="com.jsrm.web.vo.statisticalAnalysis.KnowledgeStatisticalVo" parameterType="java.util.HashMap" >
		select
		MAX(case when c.resourceTypeOneLevelId = 'courseware' then c.num else 0 end) courseware,
		MAX(case when c.resourceTypeOneLevelId = 'microClass' then c.num else 0 end) smallclass,
		MAX(case when c.resourceTypeOneLevelId = 'instructionalDesign' then c.num else 0 end) design,
		MAX(case when c.resourceTypeOneLevelId = 'practice' then c.num else 0 end) practice,
		MAX(case when c.resourceTypeOneLevelId = 'sourceMaterial' then c.num else 0 end) material,
		MAX(case when c.resourceTypeOneLevelId = 'workRecord' then c.num else 0 end) learinng,
		MAX(case when c.resourceTypeOneLevelId = 'teachingResearch' then c.num else 0 end) research,
		MAX(case when c.resourceTypeOneLevelId = 'expandingResource' then c.num else 0 end) expand,
		MAX(case when c.resourceTypeOneLevelId = 'eTextbook' then c.num else 0 end) Etextbook,
		MAX(case when c.resourceTypeOneLevelId = 'teacherBook' then c.num else 0 end) teacherbook,
		MAX(case when c.resourceTypeOneLevelId = 'scheduleAndInterpretation' then c.num else 0 end) CurriculumAndInterpretation,
		MAX(case when c.resourceTypeOneLevelId = 'teachingVideo' then c.num else 0 end) teachingvideo,
		MAX(case when c.resourceTypeOneLevelId = 'experiment' then c.num else 0 end) experiment,
		MAX(case when c.resourceTypeOneLevelId = 'middleExam' then c.num else 0 end) mediumtest,
		MAX(case when c.resourceTypeOneLevelId = 'highExam' then c.num else 0 end) nationaltest,
		MAX(case when c.resourceTypeOneLevelId = 'primaryCompetition' then c.num else 0 end) primarytest,
		MAX(case when c.resourceTypeOneLevelId = 'middleCompetition' then c.num else 0 end) middletest,
		MAX(case when c.resourceTypeOneLevelId = 'highCompetition' then c.num else 0 end) hightest,
		MAX(case when c.resourceTypeOneLevelId = 'knowledgeExplanation' then c.num else 0 end) knowledgedetail,
		MAX(case when c.resourceTypeOneLevelId = 'learningVideo' then c.num else 0 end) studyvideo,
		MAX(case when c.resourceTypeOneLevelId = 'fullTextSolution' then c.num else 0 end) textexplain,
		MAX(case when c.resourceTypeOneLevelId = 'politicalPoints' then c.num else 0 end) currentpoint,
		MAX(case when c.resourceTypeOneLevelId = 'practiceEducation' then c.num else 0 end) practicaleducation,
		MAX(case when c.resourceTypeOneLevelId = 'terminology' then c.num else 0 end) nounsexplanation,
		MAX(case when c.resourceTypeOneLevelId = 'courseware' then c.num else 0 end)  +
		MAX(case when c.resourceTypeOneLevelId = 'microClass' then c.num else 0 end)  +
		MAX(case when c.resourceTypeOneLevelId = 'instructionalDesign' then c.num else 0 end)  +
		MAX(case when c.resourceTypeOneLevelId = 'practice' then c.num else 0 end)  +
		MAX(case when c.resourceTypeOneLevelId = 'sourceMaterial' then c.num else 0 end)  +
		MAX(case when c.resourceTypeOneLevelId = 'workRecord' then c.num else 0 end)  +
		MAX(case when c.resourceTypeOneLevelId = 'teachingResearch' then c.num else 0 end)  +
		MAX(case when c.resourceTypeOneLevelId = 'expandingResource' then c.num else 0 end)  +
		MAX(case when c.resourceTypeOneLevelId = 'eTextbook' then c.num else 0 end) +
		MAX(case when c.resourceTypeOneLevelId = 'teacherBook' then c.num else 0 end)  +
		MAX(case when c.resourceTypeOneLevelId = 'scheduleAndInterpretation' then c.num else 0 end)  +
		MAX(case when c.resourceTypeOneLevelId = 'teachingVideo' then c.num else 0 end)  +
		MAX(case when c.resourceTypeOneLevelId = 'experiment' then c.num else 0 end)  +
		MAX(case when c.resourceTypeOneLevelId = 'middleExam' then c.num else 0 end)  +
		MAX(case when c.resourceTypeOneLevelId = 'highExam' then c.num else 0 end)  +
		MAX(case when c.resourceTypeOneLevelId = 'primaryCompetition' then c.num else 0 end)  +
		MAX(case when c.resourceTypeOneLevelId = 'middleCompetition' then c.num else 0 end)  +
		MAX(case when c.resourceTypeOneLevelId = 'highCompetition' then c.num else 0 end)  +
		MAX(case when c.resourceTypeOneLevelId = 'knowledgeExplanation' then c.num else 0 end)  +
		MAX(case when c.resourceTypeOneLevelId = 'learningVideo' then c.num else 0 end)  +
		MAX(case when c.resourceTypeOneLevelId = 'fullTextSolution' then c.num else 0 end)  +
		MAX(case when c.resourceTypeOneLevelId = 'politicalPoints' then c.num else 0 end)  +
		MAX(case when c.resourceTypeOneLevelId = 'practiceEducation' then c.num else 0 end)  +
		MAX(case when c.resourceTypeOneLevelId = 'terminology' then c.num else 0 end) total
		from(
		SELECT
		x.id,
		count(*) num,
		resourceTypeOneLevelId,
		createUserName,
		subjectId,
		phaseId
		FROM
		t_resource_info x
		WHERE
		1 = 1
		<if test=" userId != null and userId != ''">
			AND x.createUserId = #{userId}
		</if>
		AND x.resourceType = 'END'
		AND x.subjectId IS NOT NULL
		AND x.phaseId IS NOT NULL
		AND x.state = 3
		<if test="startTime != null and startTime != ''">
			and x.createDateTime &gt;= #{startTime}
		</if>
		<if test="endTime != null and endTime != ''">
			and x.createDateTime &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d 23:59:59.999')
		</if>
		<if test=" json != null and json != ''">
			<![CDATA[AND x.knowledgeCode like CONCAT('%',#{json},'%')]]>
		</if>
		GROUP BY
		x.resourceTypeOneLevelId
		ORDER BY
		x.subjectId DESC
		) c
	</select>

	<select id="getSubjectAllNum" resultType="com.jsrm.web.vo.statisticalAnalysis.StatisticalVo" parameterType="java.util.HashMap" >
		SELECT
		d.phase phase,
		d.`subject` subject,
		MAX(d.courseware) courseware,
		MAX(d.design) design,
		MAX(d.learinng) learinng,
		MAX(d.practice) practice,
		MAX(d.material) material,
		MAX(d.memoir) memoir,
		MAX(d.expand) expand,
		MAX(d.research) research,
		MAX(d.smallclass) smallclass,
		MAX(d.test) test,
		MAX(d.subtotal) subtotal
		FROM (
		select
		c.phase phase,c.`subject` subject,
		max(case when c.resourceTypeOneLevelId = 3 then c.num else 0 end) courseware,
		max(case when c.resourceTypeOneLevelId = 4 then c.num else 0 end) design,
		max(case when c.resourceTypeOneLevelId = 5 then c.num else 0 end) learinng,
		max(case when c.resourceTypeOneLevelId = 23 then c.num else 0 end) practice,
		max(case when c.resourceTypeOneLevelId = 24 then c.num else 0 end) material,
		max(case when c.resourceTypeOneLevelId = 25 then c.num else 0 end) memoir,
		max(case when c.resourceTypeOneLevelId = 26 then c.num else 0 end) expand,
		max(case when c.resourceTypeOneLevelId = 27 then c.num else 0 end) research,
		max(case when c.resourceTypeOneLevelId = 28 then c.num else 0 end) smallclass,
		max(case when c.resourceTypeOneLevelId = 29 then c.num else 0 end) test,
		(max(case when c.resourceTypeOneLevelId = 3 then c.num else 0 end)+
		max(case when c.resourceTypeOneLevelId = 4 then c.num else 0 end)+
		max(case when c.resourceTypeOneLevelId = 5 then c.num else 0 end)+
		max(case when c.resourceTypeOneLevelId = 23 then c.num else 0 end)+
		max(case when c.resourceTypeOneLevelId = 24 then c.num else 0 end)+
		max(case when c.resourceTypeOneLevelId = 25 then c.num else 0 end)+
		max(case when c.resourceTypeOneLevelId = 26 then c.num else 0 end)+
		max(case when c.resourceTypeOneLevelId = 27 then c.num else 0 end)+
		max(case when c.resourceTypeOneLevelId = 28 then c.num else 0 end)+
		max(case when c.resourceTypeOneLevelId = 29 then c.num else 0 end)) subtotal
		from(
		SELECT
		count(*) num,
		resourceTypeOneLevelId ,

		subject,
		phase
		FROM
		t_resource_info x
		WHERE
		1=1
		AND x.resourceType = 'END'
		AND x.subjectId is NOT NULL
		AND x.phaseId is NOT NULL
		AND x.state = 3
		<if test="startTime != null and startTime != ''">
			and x.createDateTime &gt;= #{startTime}
		</if>
		<if test="endTime != null and endTime != ''">
			and x.createDateTime &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d 23:59:59.999')
		</if>
		GROUP BY
		x.resourceTypeOneLevelId,
		x.subjectId,
		x.resourceType
		ORDER BY x.subjectId desc
		) c GROUP BY c.`subject`,c.phase) d GROUP BY d.`subject`
	</select>

	<select id="getResourceFormNum" resultType="com.jsrm.web.vo.statisticalAnalysis.ResourceForm" parameterType="java.util.HashMap" >
		SELECT
			MAX(case when c.resourceFormatId = 'rFile' then c.num else 0 end) doc,
			MAX(case when c.resourceFormatId = 'video' then c.num else 0 end) video,
			MAX(case when c.resourceFormatId = 'audio' then c.num else 0 end) audio,
			MAX(case when c.resourceFormatId = 'animation' then c.num else 0 end) flash,
			MAX(case when c.resourceFormatId = 'picture' then c.num else 0 end) image,
			MAX(case when c.resourceFormatId =  'rFile' then c.num else 0 end)+
			MAX(case when c.resourceFormatId =  'video' then c.num else 0 end)+
			MAX(case when c.resourceFormatId =  'audio' then c.num else 0 end)+
			MAX(case when c.resourceFormatId = 'animation' then c.num else 0 end)+
			MAX(case when c.resourceFormatId =  'picture' then c.num else 0 end) total
		FROM(
			SELECT
			x.id,
			count(*) num,
			resourceFormatId,
			createUserName,
			SUBJECT,
			phase
			FROM
			t_resouce_mid_categories trmc1
			inner JOIN t_resouce_mid_categories trmc2 ON trmc2.busiId = trmc1.busiId
			inner JOIN t_resouce_mid_categories trmc3 ON trmc3.busiId = trmc1.busiId
			inner JOIN t_resouce_mid_categories trmc4 ON trmc4.busiId = trmc1.busiId
			inner JOIN t_resource_info x ON trmc1.busiId = x.id
			WHERE
			1 = 1
			<if test=" userId != null and userId != ''">
				AND x.createUserId = #{userId}
			</if>
			AND trmc1.categDeep=1
			AND trmc2.categDeep=2
			AND trmc3.categDeep=3
			AND trmc4.categDeep=4
			AND x.resourceType = 'END'
			AND x.subjectId IS NOT NULL
			AND x.phaseId IS NOT NULL
			AND x.state = 3
			<if test="startTime != null and startTime != ''">
				and x.createDateTime &gt;= #{startTime}
			</if>
			<if test="endTime != null and endTime != ''">
				and x.createDateTime &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d 23:59:59.999')
			</if>
			<if test="phaseId != null and phaseId != ''">
				AND trmc1.tCategoriesId = #{phaseId}
			</if>
			<if test="subjectId != null and subjectId != ''">
				AND trmc2.tCategoriesId = #{subjectId}
			</if>
			<if test="version != null and version != ''">
				AND trmc3.tCategoriesId = #{version}
			</if>
			<if test="sakuji != null and sakuji != ''">
				AND trmc4.tCategoriesId = #{sakuji}
			</if>
			GROUP BY
			x.resourceFormatId
			ORDER BY
			x.subjectId DESC
		) c
    </select>

	<select id="getResourceFormNumTotal" resultType="com.jsrm.web.vo.statisticalAnalysis.ResourceForm" parameterType="java.util.HashMap" >
		SELECT
			MAX(case when c.resourceFormatId = 'rFile' then c.num else 0 end) doc,
			MAX(case when c.resourceFormatId = 'video' then c.num else 0 end) video,
			MAX(case when c.resourceFormatId = 'audio' then c.num else 0 end) audio,
			MAX(case when c.resourceFormatId = 'animation' then c.num else 0 end) flash,
			MAX(case when c.resourceFormatId = 'picture' then c.num else 0 end) image
		FROM(
			SELECT
			x.id,
			count(*) num,
			resourceFormatId,
			createUserName,
			SUBJECT,
			phase
			FROM
			t_resouce_mid_categories trmc1
			inner JOIN t_resouce_mid_categories trmc2 ON trmc2.busiId = trmc1.busiId
			inner JOIN t_resouce_mid_categories trmc3 ON trmc3.busiId = trmc1.busiId
			inner JOIN t_resouce_mid_categories trmc4 ON trmc4.busiId = trmc1.busiId
			inner JOIN t_resource_info x ON trmc1.busiId = x.id
			WHERE
			1 = 1
			AND x.resourceType = 'END'
			AND trmc1.categDeep=1
			AND trmc2.categDeep=2
			AND trmc3.categDeep=3
			AND trmc4.categDeep=4
			AND x.subjectId IS NOT NULL
			AND x.phaseId IS NOT NULL
			AND x.state = 3
			<if test="phaseId != null and phaseId != ''">
				AND trmc1.tCategoriesId = #{phaseId}
			</if>
			<if test="subjectId != null and subjectId != ''">
				AND trmc2.tCategoriesId = #{subjectId}
			</if>
			<if test="version != null and version != ''">
				AND trmc3.tCategoriesId = #{version}
			</if>
			<if test="sakuji != null and sakuji != ''">
				AND trmc4.tCategoriesId = #{sakuji}
			</if>
			GROUP BY
			x.resourceFormatId
			ORDER BY
			x.subjectId DESC
		) c

	</select>

	<select id="getSelectedTopic" resultType="com.jsrm.web.vo.statisticalAnalysis.SelectedTopic" parameterType="java.util.HashMap" >
		SELECT
			COUNT(c.id) topicNumber,
			sum(d.topicword) topicword,
			sum(d.topictime) topictime,
			sum(d.topicsize) topicsize
		FROM(
			SELECT
			x.id,
			x.resourceTopicCode
			FROM
			t_resouce_mid_categories trmc1
			inner JOIN t_resouce_mid_categories trmc2 ON trmc2.busiId = trmc1.busiId
			inner JOIN t_resouce_mid_categories trmc3 ON trmc3.busiId = trmc1.busiId
			inner JOIN t_resouce_mid_categories trmc4 ON trmc4.busiId = trmc1.busiId
			inner JOIN t_resource_info x ON trmc1.busiId = x.id
			WHERE
			1 = 1
			<if test=" empty neq userId ">
				AND x.createUserId = #{userId}
			</if>
			AND trmc1.categDeep=1
			AND trmc2.categDeep=2
			AND trmc3.categDeep=3
			AND trmc4.categDeep=4
			AND x.resourceType = 'DRA'
			AND x.subjectId IS NOT NULL
			AND x.phaseId IS NOT NULL
			AND x.state = 3
			<if test="startTime != null and startTime != ''">
				and x.createDateTime &gt;= #{startTime}
			</if>
			<if test="endTime != null and endTime != ''">
				and x.createDateTime &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d 23:59:59.999')
			</if>
			<if test="phaseId != null and phaseId != ''">
				AND trmc1.tCategoriesId = #{phaseId}
			</if>
			<if test="subjectId != null and subjectId != ''">
				AND trmc2.tCategoriesId = #{subjectId}
			</if>
			<if test="version != null and version != ''">
				AND trmc3.tCategoriesId = #{version}
			</if>
			<if test="sakuji != null and sakuji != ''">
				AND trmc4.tCategoriesId = #{sakuji}
			</if>
			ORDER BY
			x.subjectId DESC
		) c
		INNER JOIN (
		SELECT
		x.id,
		wordCount topicword,
	  	timeCount topictime,
		fileSize topicsize,
		x.resourceFileCode
		FROM
		t_resouce_mid_categories trmc1
		inner JOIN t_resouce_mid_categories trmc2 ON trmc2.busiId = trmc1.busiId
		inner JOIN t_resouce_mid_categories trmc3 ON trmc3.busiId = trmc1.busiId
		inner JOIN t_resouce_mid_categories trmc4 ON trmc4.busiId = trmc1.busiId
		inner JOIN t_resource_info x ON trmc1.busiId = x.id
		WHERE
		1 = 1
		<if test=" empty neq userId ">
			AND x.createUserId = #{userId}
		</if>
		AND trmc1.categDeep=1
		AND trmc2.categDeep=2
		AND trmc3.categDeep=3
		AND trmc4.categDeep=4
		AND x.resourceType = 'END'
		AND x.subjectId IS NOT NULL
		AND x.phaseId IS NOT NULL
		AND x.state = 3
		<if test="startTime != null and startTime != ''">
			and x.createDateTime &gt;= #{startTime}
		</if>
		<if test="endTime != null and endTime != ''">
			and x.createDateTime &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d 23:59:59.999')
		</if>
		<if test="phaseId != null and phaseId != ''">
			AND trmc1.tCategoriesId = #{phaseId}
		</if>
		<if test="subjectId != null and subjectId != ''">
			AND trmc2.tCategoriesId = #{subjectId}
		</if>
		<if test="version != null and version != ''">
			AND trmc3.tCategoriesId = #{version}
		</if>
		<if test="sakuji != null and sakuji != ''">
			AND trmc4.tCategoriesId = #{sakuji}
		</if>
		ORDER BY
		x.subjectId DESC
		)d ON c.resourceTopicCode = d.resourceFileCode

    </select>
	<select id="getResourceAudit" resultType="com.jsrm.web.vo.statisticalAnalysis.ResourceAudit" parameterType="java.util.HashMap" >
		select
			c.createUserName name ,c.phase phase,c.`subject` subject,
			max(case when c.resourceType !='DRA' then c.num else 0 end) audit,
			max(case when c.resourceType ='DRA' AND c.currentNode ='reapp'  then c.num else 0 end) recheck,
			max(case when c.resourceType ='DRA' AND c.currentNode ='final' then c.num else 0 end) finalr,
			(
			max(case when c.resourceType !='DRA' then c.num else 0 end)+
			max(case when c.resourceType ='DRA' AND c.currentNode ='reapp'  then c.num else 0 end)+
			max(case when c.resourceType ='DRA' AND c.currentNode ='final' then c.num else 0 end)
			) subtotal
		from(
			SELECT
			COUNT(*) num,
			tri.`subject`,
			tri.phase,
			tri.createUserName,
			tri.resourceType,
			tai.currentNode
			FROM
			t_resource_info tri
			LEFT JOIN t_approve_instance tai ON tri.id = tai.busiId
			WHERE
			1=1
			<if test=" empty neq userId ">
				AND tri.createUserId = #{userId}
			</if>
			AND tri.subjectId IS NOT NULL
			AND tri.phaseId IS NOT NULL
			AND tri.state = 3
		<if test="startTime != null and startTime != ''">
			and tri.createDateTime &gt;= #{startTime}
		</if>
		<if test="endTime != null and endTime != ''">
			and tri.createDateTime &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d 23:59:59.999')
		</if>
			GROUP BY
			tri.subjectId,
			tri.phaseId,
			tri.createUserId
		) c GROUP BY c.`subject`,c.phase
    </select>
	<select id="queryResourceAuditNum" resultType="com.jsrm.web.vo.statisticalAnalysis.ResourceAudit" parameterType="java.util.HashMap" >

		SELECT
		c.num uploadvetted,
		d.num topicvetted,
		c.num + d.num vettedNumber
		FROM
		(
		SELECT
		COUNT(*) num
		FROM
		t_resouce_mid_categories trmc1
		INNER JOIN t_resouce_mid_categories trmc2 ON trmc2.busiId = trmc1.busiId
		INNER JOIN t_resouce_mid_categories trmc3 ON trmc3.busiId = trmc1.busiId
		INNER JOIN t_resouce_mid_categories trmc4 ON trmc4.busiId = trmc1.busiId
		INNER JOIN t_resource_info tri ON trmc1.busiId = tri.id
		LEFT JOIN t_approve_history tai ON tri.id = tai.busiId
		WHERE
		1 = 1
		<if test=" empty neq userId ">
			AND tai.approveUserId = #{userId}
		</if>
		AND trmc1.categDeep = 1
		AND trmc2.categDeep = 2
		AND trmc3.categDeep = 3
		AND trmc4.categDeep = 4
		AND tri.subjectId IS NOT NULL
		AND tri.phaseId IS NOT NULL
		AND tai.busiType != 'DRA'
		AND tai.taskIndex !='start'
		AND tai.operateType != 'trans'
		<if test="startTime != null and startTime != ''">
			and tri.createDateTime &gt;= #{startTime}
		</if>
		<if test="endTime != null and endTime != ''">
			and tri.createDateTime &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d 23:59:59.999')
		</if>
		<if test="phaseId != null and phaseId != ''">
			AND trmc1.tCategoriesId = #{phaseId}
		</if>
		<if test="subjectId != null and subjectId != ''">
			AND trmc2.tCategoriesId = #{subjectId}
		</if>
		<if test="version != null and version != ''">
			AND trmc3.tCategoriesId = #{version}
		</if>
		<if test="sakuji != null and sakuji != ''">
			AND trmc4.tCategoriesId = #{sakuji}
		</if>
		) c,
		(
		SELECT
		COUNT(*) num
		FROM
		t_resouce_mid_categories trmc1
		INNER JOIN t_resouce_mid_categories trmc2 ON trmc2.busiId = trmc1.busiId
		INNER JOIN t_resouce_mid_categories trmc3 ON trmc3.busiId = trmc1.busiId
		INNER JOIN t_resouce_mid_categories trmc4 ON trmc4.busiId = trmc1.busiId
		INNER JOIN t_resource_info tri ON trmc1.busiId = tri.id
		LEFT JOIN t_approve_history tai ON tri.id = tai.busiId
		WHERE
		1 = 1
		<if test=" empty neq userId ">
			AND tai.approveUserId = #{userId}
		</if>
		AND trmc1.categDeep = 1
		AND trmc2.categDeep = 2
		AND trmc3.categDeep = 3
		AND trmc4.categDeep = 4
		AND tri.subjectId IS NOT NULL
		AND tri.phaseId IS NOT NULL
		AND tai.busiType = 'DRA'
		AND tai.taskIndex IN ('final', 'reapp')
		<if test="startTime != null and startTime != ''">
			and tri.createDateTime &gt;= #{startTime}
		</if>
		<if test="endTime != null and endTime != ''">
			and tri.createDateTime &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d 23:59:59.999')
		</if>
		<if test="phaseId != null and phaseId != ''">
			AND trmc1.tCategoriesId = #{phaseId}
		</if>
		<if test="subjectId != null and subjectId != ''">
			AND trmc2.tCategoriesId = #{subjectId}
		</if>
		<if test="version != null and version != ''">
			AND trmc3.tCategoriesId = #{version}
		</if>
		<if test="sakuji != null and sakuji != ''">
			AND trmc4.tCategoriesId = #{sakuji}
		</if>
		) d
	</select>

	<select id="queryReappAuditNum" resultType="com.jsrm.web.vo.statisticalAnalysis.ReappAudit" parameterType="java.util.HashMap" >
		SELECT
			COUNT(*) topicrechecked,
			IFNULL(sum(tri.wordCount), 0) checkedword,
			IFNULL(sum(tri.timeCount), 0) checkedtime,
			IFNULL(sum(tri.fileSize), 0) checkedsiza
		FROM
		t_resouce_mid_categories trmc1
		inner JOIN t_resouce_mid_categories trmc2 ON trmc2.busiId = trmc1.busiId
		inner JOIN t_resouce_mid_categories trmc3 ON trmc3.busiId = trmc1.busiId
		inner JOIN t_resouce_mid_categories trmc4 ON trmc4.busiId = trmc1.busiId
		inner JOIN t_resource_info tri ON trmc1.busiId = tri.id
		LEFT JOIN t_approve_history tai ON tri.id = tai.busiId
		WHERE
			1 = 1
			AND trmc1.categDeep=1
			AND trmc2.categDeep=2
			AND trmc3.categDeep=3
			AND trmc4.categDeep=4
			AND tri.subjectId IS NOT NULL
			AND tri.phaseId IS NOT NULL
			<if test=" empty neq userId ">
				AND tai.approveUserId = #{userId}
			</if>
			<if test="startTime != null and startTime != ''">
				and tri.createDateTime &gt;= #{startTime}
			</if>
			<if test="endTime != null and endTime != ''">
				and tri.createDateTime &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d 23:59:59.999')
			</if>
			AND tri.resourceType = 'DRA'
			AND tai.taskIndex = 'reapp'
			<if test="phaseId != null and phaseId != ''">
				AND trmc1.tCategoriesId = #{phaseId}
			</if>
			<if test="subjectId != null and subjectId != ''">
				AND trmc2.tCategoriesId = #{subjectId}
			</if>
			<if test="version != null and version != ''">
				AND trmc3.tCategoriesId = #{version}
			</if>
			<if test="sakuji != null and sakuji != ''">
				AND trmc4.tCategoriesId = #{sakuji}
			</if>
	</select>

	<select id="queryFinalAuditNum" resultType="com.jsrm.web.vo.statisticalAnalysis.FinalAudit" parameterType="java.util.HashMap" >
		SELECT
		COUNT(*) topicfinal,
		IFNULL(sum(tri.wordCount), 0) finalword,
		IFNULL(sum(tri.timeCount), 0) finaltime,
		IFNULL(sum(tri.fileSize), 0) finalsiza
		FROM
		t_resouce_mid_categories trmc1
		inner JOIN t_resouce_mid_categories trmc2 ON trmc2.busiId = trmc1.busiId
		inner JOIN t_resouce_mid_categories trmc3 ON trmc3.busiId = trmc1.busiId
		inner JOIN t_resouce_mid_categories trmc4 ON trmc4.busiId = trmc1.busiId
		inner JOIN t_resource_info tri ON trmc1.busiId = tri.id
		LEFT JOIN t_approve_history tai ON tri.id = tai.busiId
		WHERE
		1 = 1
		AND trmc1.categDeep=1
		AND trmc2.categDeep=2
		AND trmc3.categDeep=3
		AND trmc4.categDeep=4
		AND tri.subjectId IS NOT NULL
		AND tri.phaseId IS NOT NULL
		<if test=" empty neq userId ">
			AND tai.approveUserId = #{userId}
		</if>
		<if test="startTime != null and startTime != ''">
			and tri.createDateTime &gt;= #{startTime}
		</if>
		<if test="endTime != null and endTime != ''">
			and tri.createDateTime &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d 23:59:59.999')
		</if>
		AND tri.resourceType = 'DRA'
		AND tai.taskIndex = 'final'
		<if test="phaseId != null and phaseId != ''">
			AND trmc1.tCategoriesId = #{phaseId}
		</if>
		<if test="subjectId != null and subjectId != ''">
			AND trmc2.tCategoriesId = #{subjectId}
		</if>
		<if test="version != null and version != ''">
			AND trmc3.tCategoriesId = #{version}
		</if>
		<if test="sakuji != null and sakuji != ''">
			AND trmc4.tCategoriesId = #{sakuji}
		</if>
	</select>

	<select id="getResourceClassificationStatic" resultType="com.jsrm.web.vo.statisticalAnalysis.StatisticalVo" parameterType="java.util.HashMap" >
		select
			c.phase phase,c.`subject` subject,
			max(case when c.resourceTypeOneLevelId = 3 then c.num else 0 end) courseware,
			max(case when c.resourceTypeOneLevelId = 4 then c.num else 0 end) design,
			max(case when c.resourceTypeOneLevelId = 5 then c.num else 0 end) learinng,
			max(case when c.resourceTypeOneLevelId = 23 then c.num else 0 end) practice,
			max(case when c.resourceTypeOneLevelId = 24 then c.num else 0 end) material,
			max(case when c.resourceTypeOneLevelId = 25 then c.num else 0 end) memoir,
			max(case when c.resourceTypeOneLevelId = 26 then c.num else 0 end) expand,
			max(case when c.resourceTypeOneLevelId = 27 then c.num else 0 end) research,
			max(case when c.resourceTypeOneLevelId = 28 then c.num else 0 end) smallclass,
			max(case when c.resourceTypeOneLevelId = 29 then c.num else 0 end) test,
			(max(case when c.resourceTypeOneLevelId = 3 then c.num else 0 end)+
			max(case when c.resourceTypeOneLevelId = 4 then c.num else 0 end)+
			max(case when c.resourceTypeOneLevelId = 5 then c.num else 0 end)+
			max(case when c.resourceTypeOneLevelId = 23 then c.num else 0 end)+
			max(case when c.resourceTypeOneLevelId = 24 then c.num else 0 end)+
			max(case when c.resourceTypeOneLevelId = 25 then c.num else 0 end)+
			max(case when c.resourceTypeOneLevelId = 26 then c.num else 0 end)+
			max(case when c.resourceTypeOneLevelId = 27 then c.num else 0 end)+
			max(case when c.resourceTypeOneLevelId = 28 then c.num else 0 end)+
			max(case when c.resourceTypeOneLevelId = 29 then c.num else 0 end)) subtotal
		from(
			SELECT
			count(*) num,
			resourceTypeOneLevelId ,
			createUserName,
			subject,
			phase
			FROM
			t_resource_info x
			WHERE
			1=1
			<if test=" empty neq userId ">
				AND x.createUserId = #{userId}
			</if>
			AND x.resourceType = 'END'
			AND x.subjectId is NOT NULL
			AND x.phaseId is NOT NULL
			<if test=" categoresCode != null and categoresCode != '' ">
			<![CDATA[AND categoresCode LIKE CONCAT('%',#{categoresCode},'%')]]>
			</if>
			<if test=" categoresCodeOne != null and categoresCodeOne != '' ">
				<![CDATA[AND categoresCode LIKE CONCAT('%',#{categoresCodeOne},'%')]]>
			</if>
			AND x.state = 3
		<if test="startTime != null and startTime != ''">
			and x.createDateTime &gt;= #{startTime}
		</if>
		<if test="endTime != null and endTime != ''">
			and x.createDateTime &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d 23:59:59.999')
		</if>
		GROUP BY
		x.resourceTypeOneLevelId,
		x.subjectId,
		x.resourceType
		ORDER BY x.subjectId desc
		) c GROUP BY c.createUserName,c.`subject`,c.phase
	</select>

	<select id="getResourceFormStatic" resultType="com.jsrm.web.vo.statisticalAnalysis.ResourceForm" parameterType="java.util.HashMap" >
		select
		c.createUserName name,c.phase phase,c.`subject` subject,
		max(case when c.resourceFormatId = 10 then c.num else 0 end) document,
		max(case when c.resourceFormatId = 12 then c.num else 0 end) video,
		max(case when c.resourceFormatId = 9 then c.num else 0 end) audio,
		max(case when c.resourceFormatId = 13 then c.num else 0 end) flash,
		max(case when c.resourceFormatId = 11 then c.num else 0 end) image,
		(max(case when c.resourceFormatId = 10 then c.num else 0 end)+
		max(case when c.resourceFormatId = 12 then c.num else 0 end)+
		max(case when c.resourceFormatId = 9 then c.num else 0 end)+
		max(case when c.resourceFormatId = 13 then c.num else 0 end)+
		max(case when c.resourceFormatId = 11 then c.num else 0 end)) subtotal
		from(
		SELECT
		count(*) num,
		resourceFormatId ,
		createUserName,
		subject,
		phase
		FROM
		t_resource_info x
		WHERE
		1=1
		<if test=" empty neq userId ">
			AND x.createUserId = #{userId}
		</if>
		<if test=" categoresCode != null and categoresCode != '' ">
			<![CDATA[AND categoresCode LIKE CONCAT('%',#{categoresCode},'%')]]>
		</if>
		<if test=" categoresCodeOne != null and categoresCodeOne != '' ">
			<![CDATA[AND categoresCode LIKE CONCAT('%',#{categoresCodeOne},'%')]]>
		</if>
		AND x.resourceType = 'END'
		AND x.subjectId is NOT NULL
		AND x.phaseId is NOT NULL
		AND x.state = 3
		<if test="startTime != null and startTime != ''">
			and x.createDateTime &gt;= #{startTime}
		</if>
		<if test="endTime != null and endTime != ''">
			and x.createDateTime &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d 23:59:59.999')
		</if>
		GROUP BY
		x.resourceFormatId,
		x.subjectId,
		x.resourceType
		ORDER BY x.subjectId desc
		) c GROUP BY c.createUserName,c.`subject`,c.phase
	</select>
	<select id="getCategory" resultType="com.jsrm.model.catalog.Category" parameterType="java.util.HashMap" >
		SELECT DISTINCT
		(tbc.id) id,
		tbc.parentId parentId,
		tbc.`name` NAME,
		tbc.deep
		FROM
		t_base_categories tbc
		LEFT JOIN t_sys_mid_user_dataauthority_rel tsmu ON tbc.id = tsmu.dataAuthorityId
		OR tbc.parentId = tsmu.dataAuthorityId
		WHERE
		1 = 1
		AND tbc.flag = 0
		<if test=" empty neq userId ">
		AND tsmu.userId =  #{userId}
		</if>
		OR tbc.id IN (
		SELECT
		(tbct.id) id
		FROM
		t_base_categories tbct
		WHERE
		parentId IN (
		SELECT DISTINCT
		(t.id) id
		FROM
		t_base_categories t
		LEFT JOIN t_sys_mid_user_dataauthority_rel u ON t.id = u.dataAuthorityId
		OR t.parentId = u.dataAuthorityId
		WHERE
		1 = 1
		AND t.flag = 0
		AND t.deep = 3
		<if test=" empty neq userId ">
			AND u.userId = #{userId}
		</if>
		)
		)
		ORDER BY
		tbc.deep ASC

    </select>

	<select id="getWorkload" parameterType="java.util.HashMap" resultType="com.jsrm.web.vo.statisticalAnalysis.Workload">
		select aa.userId as id,aa.username as createUserName,aa.userDes as description,
		case when bb.num is null then 0 else bb.num end as uploadNumber,
		case when cc.num is null then 0 else cc.num end AS topicNumber,
		case when dd.checkCount is null then 0 else dd.checkCount end as vettedNumber from

		(select distinct d.userId,u.username,u.userDes,r.rolename from t_sys_mid_user_dataauthority_rel d
		inner join t_user u on u.id = d.userId
		left join t_sys_mid_user_role_rel mr on mr.USERID = u.id
		left join t_sys_role r on r.id = mr.ROLEID
		where d.dataAuthorityId in
		(select d.dataAuthorityId from t_sys_mid_user_dataauthority_rel d where d.userId = #{userId}
		   <if test="phase != null and phase != ''">
		     <choose>
		     <when test="subject != null and subject != ''">
		          and d.dataAuthorityId = concat(#{phase},"-",#{subject})
		      </when>
		      <otherwise>
		      and d.dataAuthorityId = #{phase} 
		      </otherwise>
		     </choose>
		   </if>
		)
		and r.rolename != 'BOSS'
		<if test="bj != null and bj != ''">
		and d.userId = #{userId}
		</if>
		) aa

		left join

		(select r.createUserId as userId,count(r.createUserId) as num from t_resource_info r
		inner join t_resouce_mid_categories m1 on m1.busiId = r.id and m1.categDeep = '1'
		inner join t_resouce_mid_categories m2 on m2.busiId = r.id and m2.categDeep = '2'
		where r.state = '3' and r.resourceType = 'END'
		<if test="phase != null and phase != ''">
			and m1.tCategoriesId = #{phase}
		</if>
		<if test="subject != null and subject != ''">
			and m2.tCategoriesId = #{subject}
		</if>
		<if test="startTime != null and startTime != ''">
			and r.createDateTime &gt;= #{startTime}
		</if>
		<if test="endTime != null and endTime != ''">
			and r.createDateTime &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d 23:59:59.999')
		</if>
		group by r.createUserId) 
		bb on aa.userId = bb.userId

		left join

		(select r.createUserId as userId,count(r.createUserId) as num from t_resource_info r
		inner join t_resouce_mid_categories m1 on m1.busiId = r.id and m1.categDeep = '1'
		inner join t_resouce_mid_categories m2 on m2.busiId = r.id and m2.categDeep = '2'
		where r.state = '3' and r.resourceType = 'DRA'
		<if test="phase != null and phase != ''">
			and m1.tCategoriesId = #{phase}
		</if>
		<if test="subject != null and subject != ''">
			and m2.tCategoriesId = #{subject}
		</if>
		<if test="startTime != null and startTime != ''">
			and r.createDateTime &gt;= #{startTime}
		</if>
		<if test="endTime != null and endTime != ''">
			and r.createDateTime &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d 23:59:59.999')
		</if>
		group by r.createUserId) 
		cc on aa.userId = cc.userId

		left join

		(select h.approveUserId AS userId,count(h.approveUserId) AS checkCount from t_approve_history h
		left join t_resource_info r on h.busiId = r.id
		inner join t_resouce_mid_categories m1 on m1.busiId = r.id and m1.categDeep = '1'
		inner join t_resouce_mid_categories m2 on m2.busiId = r.id and m2.categDeep = '2'
		where h.taskIndex != 'start'
		<if test="phase != null and phase != ''">
			and m1.tCategoriesId = #{phase}
		</if>
		<if test="subject != null and subject != ''">
			and m2.tCategoriesId = #{subject}
		</if>
		<if test="startTime != null and startTime != ''">
			and r.createDateTime &gt;= #{startTime}
		</if>
		<if test="endTime != null and endTime != ''">
			and r.createDateTime &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d 23:59:59.999')
		</if>
		group by h.approveUserId) 
		dd on aa.userId = dd.userId
		
		<where>
		1=1
		<if test="createUserName != null and createUserName != ''">
			and aa.username like '%${createUserName}%'
		</if>
		</where>
		
	</select>

	<select id="getResourceStatistics" parameterType="java.util.HashMap" resultType="java.util.HashMap" >
		select
		(@rowNO := @rowNo+1) AS nameNumber,
		aa.value1 as primaryResourcesClassification,
		case when aa.value2 is null then '' else aa.value2 end AS secondaryResourcesClassification,
		(case when cc.count2 is null then 0 else cc.count2 end) as count,
		(case when bb.count1 is null then 0 else bb.count1 end) as subtotal
		from
		(select d.code as id1,d.value as value1,d2.code as id2,d2.value as value2 from t_sys_dict d
		left join t_sys_dict d2 on d2.parentId = d.id
		where d.type = 'resourceType' order by d.resourceOrder) aa
		left join
		(select aa.resourceTypeOneLevelId, count(aa.resourceTypeOneLevelId) as count1 from
		(select r.resourceTypeOneLevelId from t_resource_info r
		inner join t_resouce_mid_categories m1 on m1.busiId = r.id and m1.categDeep = '1'
		inner join t_resouce_mid_categories m2 on m2.busiId = r.id and m2.categDeep = '2'
		inner join t_resouce_mid_categories m3 on m3.busiId = r.id and m3.categDeep = '3'
		inner join t_resouce_mid_categories m4 on m4.busiId = r.id and m4.categDeep = '4'
		where r.resourceType = 'END' and state = '3' and r.resourceTypeOneLevelId is not null
		<if test="createUserId != null and createUserId != ''">
			and r.createUserId = #{createUserId}
		</if>
		<if test="startTime != null and startTime != ''">
			and r.createDateTime &gt;= #{startTime}
		</if>
		<if test="endTime != null and endTime != ''">
			and r.createDateTime &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d 23:59:59.999')
		</if>
		<if test="phase != null and phase != ''">
			and m1.tCategoriesId = #{phase}
		</if>
		<if test="subject != null and subject != ''">
			and m2.tCategoriesId = #{subject}
		</if>
		<if test="version != null and version != ''">
			and m3.tCategoriesId = #{version}
		</if>
		<if test="books != null and books != ''">
			and m4.tCategoriesId = #{books}
		</if>
		) aa group by aa.resourceTypeOneLevelId) bb on aa.id1 = bb.resourceTypeOneLevelId
		left join
		(select aa.resourceTypeTwoLevelId, count(aa.resourceTypeTwoLevelId) as count2 from
		(select r.resourceTypeTwoLevelId from t_resource_info r
		inner join t_resouce_mid_categories m1 on m1.busiId = r.id and m1.categDeep = '1'
		inner join t_resouce_mid_categories m2 on m2.busiId = r.id and m2.categDeep = '2'
		inner join t_resouce_mid_categories m3 on m3.busiId = r.id and m3.categDeep = '3'
		inner join t_resouce_mid_categories m4 on m4.busiId = r.id and m4.categDeep = '4'
		where r.resourceType = 'END' and state = '3' and r.resourceTypeOneLevelId is not null
		<if test="createUserId != null and createUserId != ''">
			and r.createUserId = #{createUserId}
		</if>
		<if test="startTime != null and startTime != ''">
			and r.createDateTime &gt;= #{startTime}
		</if>
		<if test="endTime != null and endTime != ''">
			and r.createDateTime &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d 23:59:59.999')
		</if>
		<if test="phase != null and phase != ''">
			and m1.tCategoriesId = #{phase}
		</if>
		<if test="subject != null and subject != ''">
			and m2.tCategoriesId = #{subject}
		</if>
		<if test="version != null and version != ''">
			and m3.tCategoriesId = #{version}
		</if>
		<if test="books != null and books != ''">
			and m4.tCategoriesId = #{books}
		</if>
		) aa group by aa.resourceTypeTwoLevelId) cc on aa.id2 = cc.resourceTypeTwoLevelId, (select @rowNO := 0) b
	</select>

	<select id="getKnowledge" resultType="com.jsrm.model.catalog.BaseKnowledge" parameterType="java.util.HashMap" >

		select id,parentId,name,deep from t_base_knowledge
		<where>
			1=1
			<if test="empty neq phaseId">
				AND phase_id = #{phaseId}
			</if>
			<if test="empty neq subjectId">
				AND subject_id = #{subjectId}
			</if>
			AND flag = "0"
		</where>

	</select>
	<select id="getCategoryRelationLevels" resultType="java.util.HashMap" parameterType="java.util.HashMap" >
		SELECT
			code,
			name
		FROM
			(
				SELECT DISTINCT
					(
						SUBSTRING_INDEX(${level}, '-', - 1)
					) AS CODE,
					cd. NAME AS NAME
				FROM
					t_base_categories_relation cr,
					t_base_categories_dict cd
				WHERE
					cd. CODE = SUBSTRING_INDEX(${level}, '-', - 1)
			) c
		WHERE
			c.`CODE` IN (
				SELECT
					dataAuthorityId
				FROM
					t_sys_mid_user_dataauthority_rel
				WHERE
					1=1
				<if test="empty neq userId">
					AND  userId = #{userId}
				</if>
				AND deep = 1
			)
	</select>

</mapper>